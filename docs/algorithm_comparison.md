# Excelファイルと現システムの計算アルゴリズム比較

## 概要
村山式_分析用.xlsxと現システム（murayama_calculator_revised.py）の計算アルゴリズムを比較した結果、以下の相違点が確認されました。

## 主要な相違点

### 1. 等価合力qの計算式

#### Excel（H列）
```
q = (0.9 * B * (γ - c/(0.9*B)) / tan(φ)) * (1 - exp(-C/(0.9*B)*tan(φ)))
```
- 有効幅係数として0.9を直接使用
- 経験係数Kが含まれていない
- 分母に係数2が含まれていない
- **負の値を許容**

#### 現システム
```python
q = (α * B * (γ - 2*c/(α*B)) / (2*K*tan(φ))) * (1 - exp(-2*K*C*tan(φ)/(α*B)))
```
- α = 1.8（標準値）、有効幅 = α/2 = 0.9
- K = 1.0（標準値）を含む
- 分母に2*Kが含まれる
- **負の値を0に制限**（max(0, q)）

### 2. 自重の作用点lwの計算

#### Excel（J列）
```
lw = (L9*K9 + M9*N9)/(L9 + N9)
```
- K9: la + B/3（三角形部分の重心位置）
- L9: 三角形部分の重量
- M9: 複雑な式による曲線部分の重心
- N9: 曲線部分の重量
- **座標系の原点がlaから始まる**

#### 現システム
- 三角形部分の重心：B/3（切羽面から）
- 曲線部分の重心：対数らせんの解析的計算
- **座標系の原点が切羽面**

### 3. 粘着力の単位

両システムとも同じ単位（kN/m²）を使用していることが確認されました。
- Excel: 253 kN/m²
- システム: 253 kPa = 253 kN/m²

### 4. 計算結果の比較（θ=75°の例）

| パラメータ | Excel値 | システム値 | 差異 |
|-----------|---------|-----------|------|
| B [m] | 4.476 | 4.476 | 0.000 |
| r0 [m] | 4.045 | 4.045 | 0.000 |
| rd [m] | 6.686 | 6.686 | 0.000 |
| la [m] | -0.699 | -0.699 | 0.000 |
| lp [m] | 4.050 | 4.050 | 0.000 |
| **q [kN/m²]** | **-239.09** | **0.00** | **+239.09** |
| Wf [kN] | 434.30 | 434.30 | 0.000 |
| **lw [m]** | **1.14** | **2.15** | **+1.02** |

### 5. 最大支保圧の比較

- Excel: -2557.30 kN/m²（負値は安定を示す）
- 現システム: 約 700 kN/m²（正値で不安定を示す）

## 相違の影響

### qが負になる場合の解釈
- **Excel**: 負のqは地山の粘着力が大きく、上載荷重が支保効果として働くことを意味
- **現システム**: q=0として、上載荷重の支保効果を無視（保守的）

### 設計への影響
1. **粘着力が大きい地山**（c > γ*B_eff/2）では、Excelは安定側の評価
2. **現システムは常に保守的**な評価となる

## 推奨事項

### 1. 物理的妥当性の観点
- 負のqは物理的に「上向きの力」を意味し、実際には起こりにくい
- 現システムのmax(0, q)制限は工学的に妥当

### 2. 設計文書との整合性
- murayama_stability_design_revised.mdでは負のqについて言及なし
- 設計意図の確認が必要

### 3. 修正案
現システムを維持することを推奨：
- 保守的な設計となり安全側
- 物理的に妥当な範囲での計算
- ただし、Excelとの互換性が必要な場合は、オプションとして負のqを許容する設定を追加可能

## 結論
主な相違点は：
1. **qの計算式の係数**（2*Kの有無）
2. **負のqの扱い**（許容 vs 0制限）
3. **重心計算の座標系**（laからvs切羽面から）

これらの相違により、特に粘着力が大きい地山では評価結果に大きな差が生じます。